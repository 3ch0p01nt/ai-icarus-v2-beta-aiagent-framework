name: Deploy ‚Üí Test ‚Üí Destroy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  RESOURCE_GROUP_PREFIX: ci-icarus-test
  LOCATION: usgovvirginia

jobs:
  deploy:
    name: üöÄ Deploy to Azure Gov
    runs-on: ubuntu-latest
    outputs:
      resource-group: ${{ steps.deploy.outputs.resource_group }}
      backend-url: ${{ steps.deploy.outputs.backend_url }}
      frontend-url: ${{ steps.deploy.outputs.frontend_url }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Gov Login
        uses: azure/login@v1
        with:
          environment: 'AzureUSGovernment'
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üè∑Ô∏è Generate unique resource group name
        id: generate-rg
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          RG_NAME="${{ env.RESOURCE_GROUP_PREFIX }}-${TIMESTAMP}"
          echo "resource_group=$RG_NAME" >> $GITHUB_OUTPUT
          echo "Generated resource group: $RG_NAME"

      - name: üèóÔ∏è Deploy Infrastructure
        id: deploy
        run: |
          echo "Creating resource group: ${{ steps.generate-rg.outputs.resource_group }}"
          az group create \
            --name ${{ steps.generate-rg.outputs.resource_group }} \
            --location ${{ env.LOCATION }} \
            --tags Environment=CI Project=AI-Icarus-V2 ManagedBy=GitHub-Actions

          echo "Deploying Bicep template..."
          az deployment group create \
            --resource-group ${{ steps.generate-rg.outputs.resource_group }} \
            --template-file infrastructure/main.bicep \
            --parameters environment=ci \
                        azureAdClientId=${{ secrets.AZURE_AD_CLIENT_ID }} \
                        azureAdClientSecret=${{ secrets.AZURE_AD_CLIENT_SECRET }} \
                        azureAdTenantId=${{ secrets.AZURE_AD_TENANT_ID }} \
                        azureOpenAiEndpoint=${{ secrets.AZURE_OPENAI_ENDPOINT }} \
                        azureOpenAiApiKey=${{ secrets.AZURE_OPENAI_API_KEY }} \
                        azureOpenAiDeployment=${{ secrets.AZURE_OPENAI_DEPLOYMENT }}

          echo "Extracting outputs..."
          BACKEND_URL=$(az deployment group show \
            --resource-group ${{ steps.generate-rg.outputs.resource_group }} \
            --name main \
            --query properties.outputs.backendUrl.value -o tsv)

          FRONTEND_URL=$(az deployment group show \
            --resource-group ${{ steps.generate-rg.outputs.resource_group }} \
            --name main \
            --query properties.outputs.frontendUrl.value -o tsv)

          # Extract app name from backend URL (e.g., https://app-name.azurewebsites.us -> app-name)
          BACKEND_APP_NAME=$(echo $BACKEND_URL | sed 's|https://||' | sed 's|\.azurewebsites\.us.*||')

          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "backend_app_name=$BACKEND_APP_NAME" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "resource_group=${{ steps.generate-rg.outputs.resource_group }}" >> $GITHUB_OUTPUT

          echo "‚úÖ Infrastructure deployed successfully"
          echo "   Backend: $BACKEND_URL ($BACKEND_APP_NAME)"
          echo "   Frontend: $FRONTEND_URL"

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üöÄ Deploy Backend (Oryx will build dependencies)
        run: |
          cd backend

          echo "Creating deployment package (Oryx will install dependencies from requirements.txt)..."
          zip -r deploy.zip . -x "*.git*" -x "__pycache__/*" -x "*.pyc" -x ".venv/*"

          echo "Deploying with config-zip (triggers Oryx build with SCM_DO_BUILD_DURING_DEPLOYMENT)..."
          az webapp deployment source config-zip \
            --resource-group ${{ steps.generate-rg.outputs.resource_group }} \
            --name ${{ steps.deploy.outputs.backend_app_name }} \
            --src deploy.zip

          echo "‚úÖ Deployment completed - Oryx built dependencies"

      - name: ‚öõÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üé® Deploy Frontend
        run: |
          cd frontend

          echo "Installing dependencies..."
          npm ci

          echo "Building frontend..."
          VITE_API_URL=${{ steps.deploy.outputs.backend_url }} \
          VITE_AZURE_CLIENT_ID=${{ secrets.AZURE_AD_CLIENT_ID }} \
          VITE_AZURE_CLOUD=AzureUSGovernment \
          npm run build

          echo "Creating deployment package..."
          cd dist
          zip -r ../deploy.zip .
          cd ..

          echo "Getting Frontend App Service name..."
          FRONTEND_APP_NAME=$(az webapp list \
            --resource-group ${{ steps.generate-rg.outputs.resource_group }} \
            --query "[?contains(name, 'frontend')].name" -o tsv)

          echo "Deploying to Frontend App Service: $FRONTEND_APP_NAME"
          az webapp deployment source config-zip \
            --resource-group ${{ steps.generate-rg.outputs.resource_group }} \
            --name $FRONTEND_APP_NAME \
            --src deploy.zip

          echo "‚úÖ Frontend deployed successfully"

  health-check:
    name: üè• Health Check
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: ‚è≥ Wait for services to start
        run: |
          echo "Waiting 90 seconds for services to fully start..."
          sleep 90

      - name: üîç Check backend health
        run: |
          HEALTH_URL="${{ needs.deploy.outputs.backend-url }}/health"
          echo "Checking backend health: $HEALTH_URL"

          for i in {1..10}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")

            if [ "$RESPONSE" == "200" ]; then
              echo "‚úÖ Backend health check passed (attempt $i)"
              exit 0
            fi

            echo "‚è≥ Health check attempt $i/10 returned HTTP $RESPONSE, retrying..."
            sleep 10
          done

          echo "‚ùå Backend health check failed after 10 attempts"
          exit 1

      - name: üåê Check frontend accessibility
        run: |
          FRONTEND_URL="${{ needs.deploy.outputs.frontend-url }}"
          echo "Checking frontend: $FRONTEND_URL"

          for i in {1..5}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $FRONTEND_URL || echo "000")

            if [ "$RESPONSE" == "200" ]; then
              echo "‚úÖ Frontend accessible (attempt $i)"
              exit 0
            fi

            echo "‚è≥ Frontend check attempt $i/5 returned HTTP $RESPONSE, retrying..."
            sleep 10
          done

          echo "‚ùå Frontend not accessible after 5 attempts"
          exit 1

      - name: üîó Check API endpoints
        run: |
          API_URL="${{ needs.deploy.outputs.backend-url }}/api/config"
          echo "Checking API config endpoint: $API_URL"

          RESPONSE=$(curl -s $API_URL)

          if echo "$RESPONSE" | grep -q "azureEnvironment"; then
            echo "‚úÖ API endpoints responding correctly"
            echo "Response: $RESPONSE"
          else
            echo "‚ùå API endpoints not responding as expected"
            echo "Response: $RESPONSE"
            exit 1
          fi

  integration-tests:
    name: üß™ Integration Tests
    needs: [deploy, health-check]
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üì¶ Install dependencies
        run: |
          pip install pytest pytest-asyncio requests python-dotenv
          pip install -r backend/requirements.txt

      - name: üß™ Run integration tests
        env:
          API_BASE_URL: ${{ needs.deploy.outputs.backend-url }}
          TEST_USER_TOKEN: ${{ secrets.TEST_USER_TOKEN }}
          AZURE_CLOUD: ${{ env.AZURE_CLOUD }}
        run: |
          echo "Running integration tests against: $API_BASE_URL"
          pytest tests/integration/ -v --tb=short --junit-xml=test-results.xml

      - name: üìä Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: test-results.xml

  e2e-tests:
    name: üé≠ E2E Tests (Playwright)
    needs: [deploy, health-check]
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚öõÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üì¶ Install dependencies
        run: |
          cd tests/e2e
          npm ci
          npx playwright install --with-deps chromium

      - name: üé≠ Run Playwright tests
        env:
          BASE_URL: ${{ needs.deploy.outputs.frontend-url }}
          API_URL: ${{ needs.deploy.outputs.backend-url }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        run: |
          cd tests/e2e
          echo "Running E2E tests against: $BASE_URL"
          npx playwright test --reporter=html,junit

      - name: üìä Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/

      - name: üìä Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: tests/e2e/test-results/

  destroy:
    name: üóëÔ∏è Destroy Resources
    needs: [deploy, health-check, integration-tests, e2e-tests]
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: üîê Azure Gov Login
        uses: azure/login@v1
        with:
          environment: 'AzureUSGovernment'
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üóëÔ∏è Delete resource group
        run: |
          RG_NAME="${{ needs.deploy.outputs.resource-group }}"
          echo "Deleting resource group: $RG_NAME"

          az group delete \
            --name $RG_NAME \
            --yes \
            --no-wait

          echo "‚úÖ Resource group deletion initiated (async)"

      - name: ‚úÖ Verify deletion
        run: |
          RG_NAME="${{ needs.deploy.outputs.resource-group }}"

          echo "Waiting for deletion to complete..."
          for i in {1..30}; do
            if ! az group exists --name $RG_NAME 2>/dev/null; then
              echo "‚úÖ Resource group successfully deleted"
              exit 0
            fi
            echo "‚è≥ Waiting for deletion... ($i/30)"
            sleep 10
          done

          echo "‚ö†Ô∏è Deletion taking longer than expected (still in progress)"
          echo "Resource group will be deleted asynchronously"

  notify-success:
    name: ‚úÖ Notify Success
    needs: [destroy]
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: üéâ Success notification
        run: |
          echo "========================================"
          echo "‚úÖ CI/CD CYCLE COMPLETED SUCCESSFULLY!"
          echo "========================================"
          echo ""
          echo "Pipeline stages completed:"
          echo "  1. ‚úÖ Infrastructure deployed"
          echo "  2. ‚úÖ Backend deployed"
          echo "  3. ‚úÖ Frontend deployed"
          echo "  4. ‚úÖ Health checks passed"
          echo "  5. ‚úÖ Integration tests passed"
          echo "  6. ‚úÖ E2E tests passed"
          echo "  7. ‚úÖ Resources destroyed"
          echo ""
          echo "All tests passed! Application is ready for production."
          echo "========================================"

  notify-failure:
    name: ‚ùå Notify Failure
    needs: [deploy, health-check, integration-tests, e2e-tests]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: üö® Failure notification
        run: |
          echo "========================================"
          echo "‚ùå CI/CD CYCLE FAILED"
          echo "========================================"
          echo ""
          echo "Deployment information:"
          echo "  Resource Group: ${{ needs.deploy.outputs.resource-group }}"
          echo "  Backend URL: ${{ needs.deploy.outputs.backend-url }}"
          echo "  Frontend URL: ${{ needs.deploy.outputs.frontend-url }}"
          echo ""
          echo "‚ö†Ô∏è  RESOURCES LEFT RUNNING FOR DEBUGGING"
          echo ""
          echo "To investigate:"
          echo "  1. Check GitHub Actions logs above"
          echo "  2. Access deployed resources at URLs above"
          echo "  3. Check App Service logs in Azure Portal"
          echo ""
          echo "Manual cleanup when done:"
          echo "  az cloud set --name AzureUSGovernment"
          echo "  az login"
          echo "  az group delete --name ${{ needs.deploy.outputs.resource-group }}"
          echo ""
          echo "========================================"
