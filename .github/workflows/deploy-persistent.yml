name: Deploy Persistent (No Destroy)

on:
  workflow_dispatch:
    inputs:
      resource_group:
        description: 'Resource Group Name (will be created if it does not exist)'
        required: true
        default: 'ai-icarus-v2-demo'
      environment:
        description: 'Environment (dev/staging/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  LOCATION: usgovvirginia

jobs:
  deploy:
    name: üöÄ Deploy to Azure Gov (Persistent)
    runs-on: ubuntu-latest
    outputs:
      backend-url: ${{ steps.deploy.outputs.backend_url }}
      frontend-url: ${{ steps.deploy.outputs.frontend_url }}
      key_vault_name: ${{ steps.deploy.outputs.key_vault_name }}
      key_vault_uri: ${{ steps.deploy.outputs.key_vault_uri }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Gov Login
        uses: azure/login@v1
        with:
          environment: 'AzureUSGovernment'
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üè∑Ô∏è Ensure resource group exists
        run: |
          RG_NAME="${{ github.event.inputs.resource_group }}"

          if az group exists --name $RG_NAME | grep -q "true"; then
            echo "‚úÖ Resource group '$RG_NAME' already exists"
          else
            echo "Creating new resource group '$RG_NAME'..."
            az group create \
              --name $RG_NAME \
              --location ${{ env.LOCATION }} \
              --tags Environment=${{ github.event.inputs.environment }} Project=AI-Icarus-V2 ManagedBy=GitHub-Actions Persistent=true
          fi

      - name: üèóÔ∏è Deploy Infrastructure
        id: deploy
        run: |
          echo "Deploying Bicep template to ${{ github.event.inputs.resource_group }}..."
          echo "üîê Azure OpenAI API Key will be stored in Key Vault (not as environment variable)"
          az deployment group create \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --template-file infrastructure/main.bicep \
            --parameters environment=${{ github.event.inputs.environment }} \
                        azureAdClientId=${{ secrets.AZURE_AD_CLIENT_ID }} \
                        azureAdClientSecret=${{ secrets.AZURE_AD_CLIENT_SECRET }} \
                        azureAdTenantId=${{ secrets.AZURE_AD_TENANT_ID }} \
                        azureOpenAiEndpoint=${{ secrets.AZURE_OPENAI_ENDPOINT }} \
                        azureOpenAiApiKey=${{ secrets.AZURE_OPENAI_API_KEY }} \
                        azureOpenAiDeployment=${{ secrets.AZURE_OPENAI_DEPLOYMENT }}

          echo "Extracting outputs..."
          BACKEND_URL=$(az deployment group show \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --name main \
            --query properties.outputs.backendUrl.value -o tsv)

          FRONTEND_URL=$(az deployment group show \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --name main \
            --query properties.outputs.frontendUrl.value -o tsv)

          BACKEND_APP_NAME=$(az deployment group show \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --name main \
            --query properties.outputs.appServiceName.value -o tsv)

          FRONTEND_APP_NAME=$(az deployment group show \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --name main \
            --query properties.outputs.frontendAppServiceName.value -o tsv)

          KEY_VAULT_NAME=$(az deployment group show \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --name main \
            --query properties.outputs.keyVaultName.value -o tsv)

          KEY_VAULT_URI=$(az deployment group show \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --name main \
            --query properties.outputs.keyVaultUri.value -o tsv)

          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "backend_app_name=$BACKEND_APP_NAME" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "frontend_app_name=$FRONTEND_APP_NAME" >> $GITHUB_OUTPUT
          echo "key_vault_name=$KEY_VAULT_NAME" >> $GITHUB_OUTPUT
          echo "key_vault_uri=$KEY_VAULT_URI" >> $GITHUB_OUTPUT

          echo "‚úÖ Infrastructure deployed successfully"
          echo "   Backend: $BACKEND_URL ($BACKEND_APP_NAME)"
          echo "   Frontend: $FRONTEND_URL"
          echo "   Key Vault: $KEY_VAULT_NAME ($KEY_VAULT_URI)"

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üöÄ Deploy Backend (Pre-build dependencies)
        run: |
          cd backend

          echo "Installing dependencies locally..."
          pip install --target=".python_packages/lib/site-packages" -r requirements.txt

          echo "Creating deployment package with dependencies included..."
          zip -r deploy.zip . -x "*.git*" -x "__pycache__/*" -x "*.pyc" -x ".venv/*"

          echo "Deploying package..."
          az webapp deployment source config-zip \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --name ${{ steps.deploy.outputs.backend_app_name }} \
            --src deploy.zip

          echo "‚úÖ Deployment completed with pre-built dependencies"

      - name: ‚öõÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üé® Deploy Frontend
        run: |
          cd frontend

          echo "Installing dependencies..."
          npm ci

          echo "Building frontend..."
          VITE_API_URL=${{ steps.deploy.outputs.backend_url }} \
          VITE_AZURE_CLIENT_ID=${{ secrets.AZURE_AD_CLIENT_ID }} \
          VITE_AZURE_CLOUD=AzureUSGovernment \
          npm run build

          echo "Creating deployment package..."
          cd dist
          zip -r ../deploy.zip .
          cd ..

          echo "Deploying to Frontend App Service: ${{ steps.deploy.outputs.frontend_app_name }}"
          az webapp deployment source config-zip \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --name ${{ steps.deploy.outputs.frontend_app_name }} \
            --src deploy.zip

          echo "‚úÖ Frontend deployed successfully"

  health-check:
    name: üè• Health Check
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: ‚è≥ Wait for services to start
        run: |
          echo "Waiting 120 seconds for services to fully start..."
          sleep 120

      - name: üîç Check backend health
        run: |
          HEALTH_URL="${{ needs.deploy.outputs.backend-url }}/health"
          echo "Checking backend health: $HEALTH_URL"

          for i in {1..10}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")

            if [ "$RESPONSE" == "200" ]; then
              echo "‚úÖ Backend health check passed (attempt $i)"
              exit 0
            fi

            echo "‚è≥ Health check attempt $i/10 returned HTTP $RESPONSE, retrying..."
            sleep 10
          done

          echo "‚ùå Backend health check failed after 10 attempts"
          exit 1

      - name: üåê Check frontend accessibility
        run: |
          FRONTEND_URL="${{ needs.deploy.outputs.frontend-url }}"
          echo "Checking frontend: $FRONTEND_URL"

          for i in {1..5}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $FRONTEND_URL || echo "000")

            if [ "$RESPONSE" == "200" ]; then
              echo "‚úÖ Frontend accessible (attempt $i)"
              exit 0
            fi

            echo "‚è≥ Frontend check attempt $i/5 returned HTTP $RESPONSE, retrying..."
            sleep 10
          done

          echo "‚ùå Frontend not accessible after 5 attempts"
          exit 1

  notify-success:
    name: ‚úÖ Deployment Complete
    needs: [deploy, health-check]
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: üéâ Success notification
        run: |
          echo "========================================"
          echo "‚úÖ PERSISTENT DEPLOYMENT SUCCESSFUL!"
          echo "========================================"
          echo ""
          echo "Resource Group: ${{ github.event.inputs.resource_group }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo ""
          echo "üåê Access URLs:"
          echo "   Backend:  ${{ needs.deploy.outputs.backend-url }}"
          echo "   Frontend: ${{ needs.deploy.outputs.frontend-url }}"
          echo ""
          echo "üîê Key Vault (Secure Secrets Storage):"
          echo "   Name: ${{ needs.deploy.outputs.key_vault_name }}"
          echo "   URI:  ${{ needs.deploy.outputs.key_vault_uri }}"
          echo "   Secrets: azure-openai-api-key"
          echo ""
          echo "üìù Important:"
          echo "   - Resources are PERSISTENT and will NOT be auto-deleted"
          echo "   - Azure OpenAI API Key is stored in Key Vault (not as env var)"
          echo "   - Backend uses Managed Identity to access Key Vault"
          echo "   - Remember to delete when done to avoid costs"
          echo ""
          echo "üóëÔ∏è To delete manually:"
          echo "   az cloud set --name AzureUSGovernment"
          echo "   az login"
          echo "   az group delete --name ${{ github.event.inputs.resource_group }}"
          echo ""
          echo "========================================"

  notify-failure:
    name: ‚ùå Deployment Failed
    needs: [deploy, health-check]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: üö® Failure notification
        run: |
          echo "========================================"
          echo "‚ùå DEPLOYMENT FAILED"
          echo "========================================"
          echo ""
          echo "Resource Group: ${{ github.event.inputs.resource_group }}"
          echo "Backend URL: ${{ needs.deploy.outputs.backend-url }}"
          echo "Frontend URL: ${{ needs.deploy.outputs.frontend-url }}"
          echo ""
          echo "Please check GitHub Actions logs for details"
          echo ""
          echo "========================================"
